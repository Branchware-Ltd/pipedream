let home =
  <html>
    <body>
      <form method="POST" action="/" enctype="multipart/form-data">
        <input name="csrf" type="hidden" value="fake">
        <input name="file" type="file" multiple>
        <button>Submit!</button>
      </form>
    </body>
  </html>

open Lwt.Syntax

let () =
  Dream.run
  @@ Dream.logger
  @@ Dream.sessions_in_memory
  @@ Dream.router [

    Dream.get  "/" (fun _ ->
      Dream.respond home);

    Dream.post "/" (fun request ->
      let request = Dream.begin_upload request in

      let rec upload_all () =
        let* result = Dream.upload request in

        match result with
        | `File (name, filename, data) ->
          Dream.log "file %s %s %i" name filename (String.length data);
          upload_all ()

        | `Field (name, value) ->
          Dream.log "field %s %s" name value;
          upload_all ()

        | `Done ->
          Dream.log "done";
          Lwt.return_unit
      in

      let* () = upload_all () in

      Dream.respond "Ok!");

  ]
  @@ fun _ -> Dream.respond ~status:`Not_Found ""
